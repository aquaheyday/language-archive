# 📥 시스템 설계 - 과부하 제어(Backpressure) & 재시도 처리(Retry) 전략

대량의 요청이 몰리거나, 네트워크/서비스 장애 시에도 시스템을 안정적으로 유지하려면  
**과부하 제어(Backpressure)** 와 **재시도 처리(Retry)** 전략이 필수입니다.

---

## 1️⃣ 백프레셔 (Backpressure)란?

| 항목       | 설명 |
|------------|------|
| **정의**   | 소비자(Consumer)의 처리 속도보다 생산자(Producer)가 데이터를 더 빨리 보낼 때, **과부하를 방지하기 위해 흐름을 제어하는 전략** |
| **목적**   | 시스템 과부하 방지, OOM(메모리 부족), 타임아웃 방지 |
| **적용 대상** | 메시지 큐, 스트리밍 시스템, API 서버 등

---

### 백프레셔 적용 방식

| 방식                       | 설명 |
|----------------------------|------|
| **큐 제한 (Queue Limit)**     | 버퍼/큐 크기 초과 시 생산자 블로킹 or 드롭 |
| **속도 제한 (Rate Limiting)** | 요청/데이터 전송 속도를 제한하여 부하 완화 |
| **스레드/리소스 제어**        | 소비자가 처리 가능한 수준에서만 수신 |
| **응답 기반 제어**            | 처리 완료 응답 수신 전까지 추가 요청 금지 (예: TCP 흐름 제어)

---

## 2️⃣ 리트라이(Retry) 전략이란?

| 항목       | 설명 |
|------------|------|
| **정의**   | 일시적인 오류 발생 시, **요청을 다시 시도하여 처리 신뢰성을 확보**하는 전략 |
| **목적**   | 네트워크 지연, 타임아웃, 일시적 장애 등으로부터 복구 |
| **주의점** | 무한 리트라이 or 과도한 리트라이 → 오히려 시스템에 부담을 줄 수 있음

---

### 리트라이 전략 유형

| 전략                     | 설명 |
|--------------------------|------|
| **Fixed Interval Retry** | 일정 간격으로 반복 시도 (ex. 3초 간격으로 3회) |
| **Exponential Backoff**  | 시도할수록 대기 시간을 점점 증가시킴 (ex. 1s → 2s → 4s) |
| **Jitter 추가**           | 백오프에 랜덤 시간 추가 → 동시 요청 집중 방지 |
| **Max Retry Limit**      | 재시도 횟수 제한으로 무한 루프 방지 |
| **Dead Letter Queue (DLQ)** | 일정 횟수 실패 후, 문제 메시지 별도 보관하여 후속 처리

---

## 3️⃣ 백프레셔 + 리트라이 통합 전략 예시

```text
[Client]
   |
   |-- 요청 전송
   |
   v
[API Gateway]
   |
   |-- Rate Limiting 적용                     # 초당 요청 수 제한 (ex. 100 req/s)
   |-- 인증/라우팅 처리
   |
   v
[Service A (API 서버)]
   |
   |-- 외부 호출 실패 시 Exponential Backoff + Jitter 적용
   |   (예: 1초 → 2초 → 4초 + 랜덤 지연)
   |
   |-- 요청 처리 후 메시지를 큐에 발행
   v
[Message Queue (ex. Kafka, RabbitMQ)]
   |
   |-- 메시지 큐 사이즈 제한 (Backpressure 역할)
   |-- 초과 시 Producer 차단 or 메시지 드롭
   |-- 실패한 메시지는 Dead Letter Queue(DLQ)로 분리 저장
   |
   v
[Service B (Consumer)]
   |
   |-- 메시지 처리 속도가 느릴 경우 처리량 제한
   |-- 처리 불가능 시 Nack(부정 응답) → 재시도 or DLQ 이동
   |
   v
[DB / Storage / 외부 API]
   |
   |-- 결과 저장 or 후속 처리
```

---

## 4️⃣ 실무 적용 팁

- **백프레셔**:
  - 메시지 큐(예: Kafka, RabbitMQ)에 buffer size, consumer 처리율 주의
  - HTTP 서버에서는 429 Too Many Requests 응답 반환 가능
  - gRPC 스트리밍은 Flow Control 지원

- **리트라이**:
  - 외부 API 호출 시 반드시 적용 (Exponential Backoff + Jitter 추천)
  - 리트라이 간 로깅 주의 (오류 로그 폭발 방지)
  - 실패 요청은 DLQ 또는 모니터링 시스템에 적재

---

## 🎯 정리 요약

✔ **백프레셔**는 시스템의 처리 능력을 초과하지 않도록 **흐름을 제어**하는 방식  
✔ **리트라이**는 일시적 실패에 **회복 가능성**을 부여하는 방식  
✔ 둘 다 잘못 구성하면 **오히려 시스템에 더 큰 부하**가 될 수 있음  
✔ **재시도 전략은 신중히, 백프레셔는 선제적으로** 설계해야 함
